- name: Create a test cluster
  mongodb_atlas_cluster:
    apiUsername: "{{ atlas_api_user }}"
    apiPassword: "{{ atlas_api_password }}"
    groupId: "{{ atlas_api_project }}"
    name: "testcluster"
    mongoDBMajorVersion: "5.0"
    clusterType: "REPLICASET"
    providerSettings:
      providerName: "GCP"
      regionName: "WESTERN_EUROPE"
      instanceSizeName: "M10"
    pitEnabled: False
    providerBackupEnabled: False
  register: create_cluster

- name: Update a test cluster
  mongodb_atlas_cluster:
    apiUsername: "{{ atlas_api_user }}"
    apiPassword: "{{ atlas_api_password }}"
    groupId: "{{ atlas_api_project }}"
    name: "testcluster"
    mongoDBMajorVersion: "5.0"
    clusterType: "REPLICASET"
    providerSettings:
      providerName: "GCP"
      regionName: "WESTERN_EUROPE"
      instanceSizeName: "M10"
    pitEnabled: False
    providerBackupEnabled: False
  register: update_cluster

# the mongodb_atlas_cluster plugin is currently not idempotent
#- name: Update a test cluster (idempotency)
#  mongodb_atlas_cluster:
#    apiUsername: "{{ atlas_api_user }}"
#    apiPassword: "{{ atlas_api_password }}"
#    groupId: "{{ atlas_api_project }}"
#    name: "testcluster"
#    mongoDBMajorVersion: "5.0"
#    clusterType: "REPLICASET"
#    providerSettings:
#      providerName: "GCP"
#      regionName: "WESTERN_EUROPE"
#      instanceSizeName: "M10"
#    pitEnabled: False
#    providerBackupEnabled: False
#  register: update_cluster_idempotency

- name: Delete a test cluster
  mongodb_atlas_cluster:
    apiUsername: "{{ atlas_api_user }}"
    apiPassword: "{{ atlas_api_password }}"
    groupId: "{{ atlas_api_project }}"
    state: absent
    name: "testcluster"
    mongoDBMajorVersion: "5.0"
    clusterType: "REPLICASET"
    providerSettings:
      providerName: "GCP"
      regionName: "WESTERN_EUROPE"
      instanceSizeName: "M10"
    pitEnabled: False
  register: delete_cluster

# the mongodb_atlas_cluster plugin is currently not idempotent
#- name: Update a test cluster (idempotency)
#  atlas_cluster:
#    apiUsername: "{{ atlas_api_user }}"
#    apiPassword: "{{ atlas_api_password }}" 
#    groupId: "{{ atlas_api_project }}"
#    state: absent
#    name: "testcluster"
#    mongoDBMajorVersion: "4.2"
#    clusterType: "REPLICASET"
#    providerSettings:
#      providerName: "GCP"
#      regionName: "WESTERN_EUROPE"
#      instanceSizeName: "M10"
#    pitEnabled: False
#  register: delete_cluster_idempotency

- name: Check test cases
  ansible.builtin.assert:
    that:
      - create_cluster.changed == True
      - create_cluster.diff.after == "state: created\n"
      - update_cluster.changed == True
      - update_cluster.diff.after
      #- update_cluster_idempotency.changed == False
      - delete_cluster.changed == True
      - delete_cluster.diff.after == "state: absent\n"
      #- delete_cluster_idempotency.changed == False
